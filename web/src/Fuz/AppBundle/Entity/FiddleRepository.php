<?php

namespace Fuz\AppBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\NoResultException;
use Fuz\AppBundle\Entity\User;
use Fuz\AppBundle\Entity\Fiddle;

/**
 * FiddleRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class FiddleRepository extends EntityRepository
{

    public function getFiddle($hash, $revision, User $user = null)
    {
        if (!is_null($hash))
        {
            $qb = $this
               ->createQueryBuilder('f');
            $qb
               ->where(
                  $qb->expr()->andX(
                     $qb->expr()->eq('f.hash', ':hash'),
                     $qb->expr()->eq('f.revision', ':revision'),
                     $qb->expr()->orX(
                        $qb->expr()->neq('f.visibility', ':private'),
                        $qb->expr()->eq('f.user', ':user')
                     )
                  )
               )
               ->setParameters(array(
                       'hash' => $hash,
                       'revision' => $revision,
                       'private' => Fiddle::VISIBILITY_PRIVATE,
                       'user' => $user ? $user->getId() : -1,
               ))
            ;
            $query = $qb->getQuery();
            $fiddle = $query->getOneOrNullResult();
            if (is_null($fiddle))
            {
                $fiddle = new Fiddle();
                $fiddle->setHash($hash);
            }
        }
        else
        {
            $fiddle = new Fiddle();
        }
        return $fiddle;
    }

}
